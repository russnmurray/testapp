/* ****************************
** Copyright (c) 2015        **
** Riverbed Technology, Inc. **
** All Rights Reserved.      **
** ************************* */

"use strict";

// *****************************
// Output Process Module
// *****************************

// required modules
var outputToSocket = require('./trace-output-tcp');
// first arg is stringified options object
// second arg is id for identifying results (moniker)
// third arg is PID of this process
outputToSocket.init(JSON.parse(process.argv[2]), process.argv[3], process.argv[4]);

process.on("message",function(m){
	if(m.trace) {
		outputToSocket.addTraceResult(m.trace);
	} else if(m.env) {
		outputToSocket.addEnvResult(m.env);
	} else if(m.envProps) {
		outputToSocket.setEnvProps(m.envProps);
	} else if(m.log) {
		outputToSocket.logOverTCP(m.log.level, m.log.msg);
	} else if(m.debugMode) {
		outputToSocket.setDebugMode(m.debugMode);
	} else {
		require('./trace-output-api').info('trace-output-process-tcp','ignoring unknown message type: '+m);
	}
});

// listen for this to be disconnected from the parent.
// when that happens, terminate the child process.
process.on("disconnect",function(){
	
	//TODO - finish shutting down nicely
	outputToSocket.cleanup();
	process.exit();
});

process.on('uncaughtException', function (err) {
	  console.error(err.stack);
	  process.exit(1);
});