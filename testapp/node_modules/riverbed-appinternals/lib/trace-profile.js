/* ****************************
** Copyright (c) 2015        **
** Riverbed Technology, Inc. **
** All Rights Reserved.      **
** ************************* */

"use strict";

// *****************************
// Profiling Module
// *****************************

// required modules
var traceConfig = require('./trace-config'),
	traceOutputApi = require('./trace-output-api');

// Internal variables
var profiler;

// -----------------------------
// External Functions
// -----------------------------

exports.startProfiling = function(id){
	// don't allow profiling when instrumentation is short circuited
	if(!traceConfig.isShortCircuited() && profiler) {	
		profiler.startProfiling(id);
		traceOutputApi.info('trace-profile.startProfiling','started profiling id: '+id);
	}
};

exports.stopProfiling = function(id){
	if(profiler) {
		// NOTE: intentionally no check for isShortCircuited here
		// we probably DO want to allow a profile to be stopped at any point
		// even if the instrumentation has been short-circuited since the profile was started
		var profile = profiler.stopProfiling(id);
		traceOutputApi.info('trace-profile.stopProfiling','finished profiling id: '+id);
		traceOutputApi.addProfileResult(id,profile);
	}
};

exports.takeSnapshot = function(id) {
	// don't allow snapshotting when instrumentation is short circuited
	if(!traceConfig.isShortCircuited() && profiler) {
		var snapshot = profiler.takeSnapshot(id);
		traceOutputApi.info('trace-profile.takeSnapshot','took snapshot with id: '+id);
		traceOutputApi.addSnapshotResult(id,snapshot);
	}
};

exports.enableProfilerSupport = function(requiredMod) {
	try {
		profiler = require(requiredMod);
	} catch(err) {
		traceOutputApi.error("trace-profile.enableProfilerSupport","Could not enable profiling support: "+err);
	}
}